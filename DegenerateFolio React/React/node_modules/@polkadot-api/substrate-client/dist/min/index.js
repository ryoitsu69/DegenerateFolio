"use strict";var B=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var ue=(r,e,t)=>e in r?B(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var me=(r,e)=>{for(var t in e)B(r,t,{get:e[t],enumerable:!0})},de=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of pe(e))!le.call(r,o)&&o!==t&&B(r,o,{get:()=>e[o],enumerable:!(n=ce(e,o))||n.enumerable});return r};var fe=r=>de(B({},"__esModule",{value:!0}),r);var P=(r,e,t)=>(ue(r,typeof e!="symbol"?e+"":e,t),t),Z=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var y=(r,e,t)=>(Z(r,e,"read from private field"),t?t.call(r):e.get(r)),$=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},W=(r,e,t,n)=>(Z(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var ve={};me(ve,{DestroyedError:()=>v,DisjointError:()=>S,OperationError:()=>O,OperationInaccessibleError:()=>F,OperationLimitError:()=>C,RpcError:()=>_,StopError:()=>k,TransactionError:()=>M,createClient:()=>Ee});module.exports=fe(ve);var z=require("@polkadot-api/utils"),H=r=>(...e)=>new Promise((t,n)=>{let o=z.noop,[p,a]=e[e.length-1]instanceof AbortSignal?[e.slice(0,e.length-1),e[e.length-1]]:[e],d=()=>{o(),n(new z.AbortError)};a?.addEventListener("abort",d,{once:!0});let s=c=>f=>{o=z.noop,a?.removeEventListener("abort",d),c(f)};o=r(s(t),s(n),...p)});function ee(){let r=()=>{},e=()=>{};return{promise:new Promise((n,o)=>{r=n,e=o}),res:r,rej:e}}var T=()=>{};var U=()=>{let r=new Map;return{has:r.has.bind(r),subscribe(e,t){r.set(e,t)},unsubscribe(e){r.delete(e)},next(e,t){r.get(e)?.next(t)},error(e,t){let n=r.get(e);n&&(r.delete(e),n.error(t))},errorAll(e){let t=[...r.values()];r.clear(),t.forEach(n=>{n.error(e)})}}},E,w,D=class{constructor(){$(this,E,void 0);$(this,w,void 0);W(this,E,new Map),W(this,w,null)}checkClear(){y(this,E).size>0||(clearInterval(y(this,w)),W(this,w,null))}set(e,t){let n=y(this,E).get(e)?.messages??[];n.push(t),y(this,E).set(e,{expiry:Date.now()+2e3,messages:n}),W(this,w,y(this,w)||setInterval(()=>{let o=Date.now();[...y(this,E).entries()].forEach(([p,a])=>{a.expiry>o&&y(this,E).delete(p)}),this.checkClear()},2e3))}retrieve(e){let t=y(this,E).get(e);return t?(y(this,E).delete(e),this.checkClear(),t.messages):[]}clear(){y(this,E).clear(),this.checkClear()}};E=new WeakMap,w=new WeakMap;var _=class extends Error{constructor(t){super(t.message);P(this,"code");P(this,"data");this.code=t.code,this.data=t.data,this.name="RpcError"}};var v=class extends Error{constructor(){super("Client destroyed"),this.name="DestroyedError"}};var re=r=>{let e=new Map,t=U(),n=new D,o=null,p=(f,l,u)=>{o.send(JSON.stringify({jsonrpc:"2.0",id:f,method:l,params:u}))};function a(f){try{let l,u,m,b,i,R=JSON.parse(f);if({id:l,result:u,error:m,params:b}=R,l){let h=e.get(l);return h?(e.delete(l),m?h.onError(new _(m)):h.onSuccess(u,(q,L,I)=>{let A=q+L;t.subscribe(A,I);let j=n.retrieve(A);return j.length&&Promise.resolve().then(()=>{j.forEach(x=>{t.next(A,x)})}),()=>{t.unsubscribe(A)}})):void 0}if({subscription:i,result:u,error:m}=b,!i||!m&&!Object.hasOwn(b,"result"))throw 0;let g=R.method+i;t.has(g)||n.set(g,f),m?t.error(g,new _(m)):t.next(g,u)}catch(l){console.warn("Error parsing incomming message: "+f),console.error(l)}}o=r(a);let d=()=>{o?.disconnect(),o=null,t.errorAll(new v),e.forEach(f=>f.onError(new v)),e.clear(),n.clear()},s=1;return{request:(f,l,u)=>{if(!o)throw new Error("Not connected");let m=s++;return u&&e.set(m,u),p(m,f,l),()=>{e.delete(m)}},disconnect:d}};var be=r=>{let{event:e,...t}=r;return{type:e,...t}},Re=new Set(["dropped","invalid","finalized","error"]);function ge(r){return Re.has(r.event)}var M=class extends Error{constructor(t){super(`TxError: ${t.event} - ${t.error}`);P(this,"type");P(this,"error");this.type=t.event,this.error=t.error,this.name="TransactionError"}},G=r=>(e,t,n,o)=>{let p=r(e+"_unstable_submitAndWatch",[t],{onSuccess:(a,d)=>{let s=d(e+"_unstable_watchEvent",a,{next:c=>{if(ge(c)&&(s(),p=T,c.event!=="finalized"))return o(new M(c));n(be(c))},error(c){c instanceof v||p(),p=T,o(c)}});p=()=>{s(),r(e+"_unstable_unwatch",[a])}},onError:o});return()=>{p()}};var k=class extends Error{constructor(){super("ChainHead stopped"),this.name="StopError"}},S=class extends Error{constructor(){super("ChainHead disjointed"),this.name="DisjointError"}},C=class extends Error{constructor(){super("ChainHead operations limit reached"),this.name="OperationLimitError"}},O=class extends Error{constructor(e){super(e),this.name="OperationError"}},F=class extends Error{constructor(){super("ChainHead operation inaccessible"),this.name="OperationInaccessibleError"}};var N=(r,e)=>t=>H((n,o,...p)=>{let[a,d]=e(...p),s=t(r,a,{onSuccess:(c,f)=>{if(c.result==="limitReached")return s=T,o(new C);let l=!0,u=T,m=i=>{l=!1,u(),n(i)},b=i=>{l=!1,u(),o(i)};u=f(c.operationId,{next:i=>{let R=i;R.event==="operationError"?o(new O(R.error)):R.event==="operationInaccessible"?o(new F):d(i,m,b)},error:b}),s=()=>{l&&(u(),t("chainHead_unstable_stopOperation",[c.operationId]))}},onError:o});return()=>{s()}});var te=N("chainHead_unstable_body",r=>[[r],(e,t)=>{t(e.value)}]);var ne=N("chainHead_unstable_call",(r,e,t)=>[[r,e,t],(n,o)=>{o(n.output)}]);var oe=r=>e=>new Promise((t,n)=>{r("chainHead_unstable_header",[e],{onSuccess:t,onError:n})});var X=require("@polkadot-api/utils");var J=r=>(e,t,n,o,p,a,d)=>{if(t.length===0)return a(),X.noop;let s=r("chainHead_unstable_storage",[e,t,n],{onSuccess:(c,f)=>{if(c.result==="limitReached"||c.discardedItems===t.length)return p(new C);let l=f(c.operationId,{next:b=>{switch(b.event){case"operationStorageItems":{o(b.items);break}case"operationStorageDone":{m();break}case"operationError":{u(new O(b.error));break}case"operationInaccessible":{u(new F);break}default:r("chainHead_unstable_continue",[])}},error:p});s=()=>{l(),r("chainHead_unstable_stopOperation",[c.operationId])};let u=b=>{s=X.noop,l(),p(b)},m=()=>{s=X.noop,l(),a()};d(c.discardedItems)},onError:p});return()=>{s()}};var ie=r=>{let e=J(r);return H((t,n,o,p,a,d)=>{let s=p.startsWith("descendants"),c=s?[]:null,l=e(o,[{key:a,type:p}],d??null,s?u=>{c.push(...u)}:u=>{c=u[0]?.[p]},n,()=>{t(c)},u=>{u>0&&(l(),n(new C))});return l})};var se=r=>e=>new Promise((t,n)=>{r("chainHead_unstable_unpin",[e],{onSuccess(){t()},onError:n})});function he(r){return r.operationId!==void 0}function K(r){return(e,t,n)=>{let o=U(),p=new D,a=new Set,d=ee(),s=d.promise,c=i=>{if(he(i))return o.has(i.operationId)||p.set(i.operationId,i),o.next(i.operationId,i);if(i.event!=="stop"){if(i.event==="initialized")return t({type:i.event,finalizedBlockHashes:"finalizedBlockHash"in i?[i.finalizedBlockHash]:i.finalizedBlockHashes,finalizedBlockRuntime:i.finalizedBlockRuntime});let{event:R,...g}=i;return t({type:R,...g})}n(new k),m(!1)},f=i=>{n(i),m(!(i instanceof v))},m=r("chainHead_unstable_follow",[e],{onSuccess:(i,R)=>{let g=R("chainHead_unstable_followEvent",i,{next:c,error:f});m=(h=!0)=>{s=null,m=T,g(),h&&r("chainHead_unstable_unfollow",[i]),o.errorAll(new S),a.forEach(q=>{q()}),a.clear(),p.clear()},s=i,d.res(i)},onError:i=>{i instanceof v?m(!1):n(i),s=null,d.res(i)}}),b=(i,R,g)=>{let h=()=>{g?.onError(new S)};if(s===null)return h(),T;let q=I=>{if(!g)return r(i,[I,...R]);a.add(h);let A=(x,V)=>{if(s===null)return V.error(new S),T;o.subscribe(x,V);let Y=p.retrieve(x);return Y.length&&Promise.resolve().then(()=>{Y.forEach(ae=>{o.next(x,ae)})}),()=>{o.unsubscribe(x)}},j=r(i,[I,...R],{onSuccess:x=>{a.delete(h),g.onSuccess(x,A)},onError:x=>{a.delete(h),g.onError(x)}});return()=>{a.delete(h),j()}};if(typeof s=="string")return q(s);let L=T;return s.then(I=>{if(I instanceof Error)return h();s&&(L=q(I))}),()=>{L()}};return{unfollow(){m(),s=null},body:te(b),call:ne(b),header:oe(b),storage:ie(b),storageSubscription:J(b),unpin:se(b),_request:b}}}var Q=require("@polkadot-api/utils");var Ee=r=>{let e=re(r),t=H((a,d,s,c)=>e.request(s,c,{onSuccess:a,onError:d})),n=t("rpc_methods",[]).then(a=>n=new Set(Array.isArray(a)?a:a.methods));n.catch(Q.noop);let o=a=>a.has("transaction_unstable_submitAndWatch")?"transaction":"transactionWatch",p=G(e.request);return{chainHead:K(e.request),transaction:(a,d,s)=>{if(n instanceof Promise){let c=Q.noop,f=!0;return n.then(l=>{f&&(c=p(o(l),a,d,s))}),()=>{f=!1,c()}}return p(o(n),a,d,s)},destroy:()=>{e.disconnect()},request:t,_request:e.request}};
//# sourceMappingURL=index.js.map