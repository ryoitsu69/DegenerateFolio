{"ast":null,"code":"import { BehaviorSubject, combineLatest, EMPTY, map, of, startWith, switchMap, tap, toArray } from 'rxjs';\nimport { arrayFlatten, isFunction, nextTick } from '@polkadot/util';\nimport { memo } from '../util/index.js';\nimport { extractContributed } from './util.js';\nconst PAGE_SIZE_K = 1000; // limit aligned with the 1k on the node (trie lookups are heavy)\nfunction _getUpdates(api, paraId) {\n  let added = [];\n  let removed = [];\n  return api.query.system.events().pipe(switchMap(events => {\n    const changes = extractContributed(paraId, events);\n    if (changes.added.length || changes.removed.length) {\n      added = added.concat(...changes.added);\n      removed = removed.concat(...changes.removed);\n      return of({\n        added,\n        addedDelta: changes.added,\n        blockHash: events.createdAtHash?.toHex() || '-',\n        removed,\n        removedDelta: changes.removed\n      });\n    }\n    return EMPTY;\n  }), startWith({\n    added,\n    addedDelta: [],\n    blockHash: '-',\n    removed,\n    removedDelta: []\n  }));\n}\nfunction _eventTriggerAll(api, paraId) {\n  return api.query.system.events().pipe(switchMap(events => {\n    const items = events.filter(({\n      event: {\n        data: [eventParaId],\n        method,\n        section\n      }\n    }) => section === 'crowdloan' && ['AllRefunded', 'Dissolved', 'PartiallyRefunded'].includes(method) && eventParaId.eq(paraId));\n    return items.length ? of(events.createdAtHash?.toHex() || '-') : EMPTY;\n  }), startWith('-'));\n}\nfunction _getKeysPaged(api, childKey) {\n  const subject = new BehaviorSubject(undefined);\n  return subject.pipe(switchMap(startKey => api.rpc.childstate.getKeysPaged(childKey, '0x', PAGE_SIZE_K, startKey)), tap(keys => {\n    nextTick(() => {\n      keys.length === PAGE_SIZE_K ? subject.next(keys[PAGE_SIZE_K - 1].toHex()) : subject.complete();\n    });\n  }), toArray(),\n  // toArray since we want to startSubject to be completed\n  map(keyArr => arrayFlatten(keyArr)));\n}\nfunction _getAll(api, paraId, childKey) {\n  return _eventTriggerAll(api, paraId).pipe(switchMap(() => isFunction(api.rpc.childstate.getKeysPaged) ? _getKeysPaged(api, childKey) : api.rpc.childstate.getKeys(childKey, '0x')), map(keys => keys.map(k => k.toHex())));\n}\nfunction _contributions(api, paraId, childKey) {\n  return combineLatest([_getAll(api, paraId, childKey), _getUpdates(api, paraId)]).pipe(map(([keys, {\n    added,\n    blockHash,\n    removed\n  }]) => {\n    const contributorsMap = {};\n    keys.forEach(k => {\n      contributorsMap[k] = true;\n    });\n    added.forEach(k => {\n      contributorsMap[k] = true;\n    });\n    removed.forEach(k => {\n      delete contributorsMap[k];\n    });\n    return {\n      blockHash,\n      contributorsHex: Object.keys(contributorsMap)\n    };\n  }));\n}\nexport function contributions(instanceId, api) {\n  return memo(instanceId, paraId => api.derive.crowdloan.childKey(paraId).pipe(switchMap(childKey => childKey ? _contributions(api, paraId, childKey) : of({\n    blockHash: '-',\n    contributorsHex: []\n  }))));\n}","map":{"version":3,"names":["BehaviorSubject","combineLatest","EMPTY","map","of","startWith","switchMap","tap","toArray","arrayFlatten","isFunction","nextTick","memo","extractContributed","PAGE_SIZE_K","_getUpdates","api","paraId","added","removed","query","system","events","pipe","changes","length","concat","addedDelta","blockHash","createdAtHash","toHex","removedDelta","_eventTriggerAll","items","filter","event","data","eventParaId","method","section","includes","eq","_getKeysPaged","childKey","subject","undefined","startKey","rpc","childstate","getKeysPaged","keys","next","complete","keyArr","_getAll","getKeys","k","_contributions","contributorsMap","forEach","contributorsHex","Object","contributions","instanceId","derive","crowdloan"],"sources":["/home/ryoitsu/Documents/test/react-todo-app/node_modules/@polkadot/api-derive/crowdloan/contributions.js"],"sourcesContent":["import { BehaviorSubject, combineLatest, EMPTY, map, of, startWith, switchMap, tap, toArray } from 'rxjs';\nimport { arrayFlatten, isFunction, nextTick } from '@polkadot/util';\nimport { memo } from '../util/index.js';\nimport { extractContributed } from './util.js';\nconst PAGE_SIZE_K = 1000; // limit aligned with the 1k on the node (trie lookups are heavy)\nfunction _getUpdates(api, paraId) {\n    let added = [];\n    let removed = [];\n    return api.query.system.events().pipe(switchMap((events) => {\n        const changes = extractContributed(paraId, events);\n        if (changes.added.length || changes.removed.length) {\n            added = added.concat(...changes.added);\n            removed = removed.concat(...changes.removed);\n            return of({ added, addedDelta: changes.added, blockHash: events.createdAtHash?.toHex() || '-', removed, removedDelta: changes.removed });\n        }\n        return EMPTY;\n    }), startWith({ added, addedDelta: [], blockHash: '-', removed, removedDelta: [] }));\n}\nfunction _eventTriggerAll(api, paraId) {\n    return api.query.system.events().pipe(switchMap((events) => {\n        const items = events.filter(({ event: { data: [eventParaId], method, section } }) => section === 'crowdloan' &&\n            ['AllRefunded', 'Dissolved', 'PartiallyRefunded'].includes(method) &&\n            eventParaId.eq(paraId));\n        return items.length\n            ? of(events.createdAtHash?.toHex() || '-')\n            : EMPTY;\n    }), startWith('-'));\n}\nfunction _getKeysPaged(api, childKey) {\n    const subject = new BehaviorSubject(undefined);\n    return subject.pipe(switchMap((startKey) => api.rpc.childstate.getKeysPaged(childKey, '0x', PAGE_SIZE_K, startKey)), tap((keys) => {\n        nextTick(() => {\n            keys.length === PAGE_SIZE_K\n                ? subject.next(keys[PAGE_SIZE_K - 1].toHex())\n                : subject.complete();\n        });\n    }), toArray(), // toArray since we want to startSubject to be completed\n    map((keyArr) => arrayFlatten(keyArr)));\n}\nfunction _getAll(api, paraId, childKey) {\n    return _eventTriggerAll(api, paraId).pipe(switchMap(() => isFunction(api.rpc.childstate.getKeysPaged)\n        ? _getKeysPaged(api, childKey)\n        : api.rpc.childstate.getKeys(childKey, '0x')), map((keys) => keys.map((k) => k.toHex())));\n}\nfunction _contributions(api, paraId, childKey) {\n    return combineLatest([\n        _getAll(api, paraId, childKey),\n        _getUpdates(api, paraId)\n    ]).pipe(map(([keys, { added, blockHash, removed }]) => {\n        const contributorsMap = {};\n        keys.forEach((k) => {\n            contributorsMap[k] = true;\n        });\n        added.forEach((k) => {\n            contributorsMap[k] = true;\n        });\n        removed.forEach((k) => {\n            delete contributorsMap[k];\n        });\n        return {\n            blockHash,\n            contributorsHex: Object.keys(contributorsMap)\n        };\n    }));\n}\nexport function contributions(instanceId, api) {\n    return memo(instanceId, (paraId) => api.derive.crowdloan.childKey(paraId).pipe(switchMap((childKey) => childKey\n        ? _contributions(api, paraId, childKey)\n        : of({ blockHash: '-', contributorsHex: [] }))));\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}