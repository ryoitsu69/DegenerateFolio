{"ast":null,"code":"import { unsafeEvalSupported } from '../../../../utils/browser/unsafeEvalSupported.mjs';\nimport { Buffer } from '../buffer/Buffer.mjs';\nimport { BufferUsage } from '../buffer/const.mjs';\n\"use strict\";\nclass UboSystem {\n  constructor(adaptor) {\n    /** Cache of uniform buffer layouts and sync functions, so we don't have to re-create them */\n    this._syncFunctionHash = /* @__PURE__ */Object.create(null);\n    this._adaptor = adaptor;\n    this._systemCheck();\n  }\n  /**\n   * Overrideable function by `pixi.js/unsafe-eval` to silence\n   * throwing an error if platform doesn't support unsafe-evals.\n   * @private\n   */\n  _systemCheck() {\n    if (!unsafeEvalSupported()) {\n      throw new Error(\"Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.\");\n    }\n  }\n  ensureUniformGroup(uniformGroup) {\n    const uniformData = this.getUniformGroupData(uniformGroup);\n    uniformGroup.buffer || (uniformGroup.buffer = new Buffer({\n      data: new Float32Array(uniformData.layout.size / 4),\n      usage: BufferUsage.UNIFORM | BufferUsage.COPY_DST\n    }));\n  }\n  getUniformGroupData(uniformGroup) {\n    return this._syncFunctionHash[uniformGroup._signature] || this._initUniformGroup(uniformGroup);\n  }\n  _initUniformGroup(uniformGroup) {\n    const uniformGroupSignature = uniformGroup._signature;\n    let uniformData = this._syncFunctionHash[uniformGroupSignature];\n    if (!uniformData) {\n      const elements = Object.keys(uniformGroup.uniformStructures).map(i => uniformGroup.uniformStructures[i]);\n      const layout = this._adaptor.createUboElements(elements);\n      const syncFunction = this._generateUboSync(layout.uboElements);\n      uniformData = this._syncFunctionHash[uniformGroupSignature] = {\n        layout,\n        syncFunction\n      };\n    }\n    return this._syncFunctionHash[uniformGroupSignature];\n  }\n  _generateUboSync(uboElements) {\n    return this._adaptor.generateUboSync(uboElements);\n  }\n  syncUniformGroup(uniformGroup, data, offset) {\n    const uniformGroupData = this.getUniformGroupData(uniformGroup);\n    uniformGroup.buffer || (uniformGroup.buffer = new Buffer({\n      data: new Float32Array(uniformGroupData.layout.size / 4),\n      usage: BufferUsage.UNIFORM | BufferUsage.COPY_DST\n    }));\n    data || (data = uniformGroup.buffer.data);\n    offset || (offset = 0);\n    uniformGroupData.syncFunction(uniformGroup.uniforms, data, offset);\n    return true;\n  }\n  updateUniformGroup(uniformGroup) {\n    if (uniformGroup.isStatic && !uniformGroup._dirtyId) return false;\n    uniformGroup._dirtyId = 0;\n    const synced = this.syncUniformGroup(uniformGroup);\n    uniformGroup.buffer.update();\n    return synced;\n  }\n  destroy() {\n    this._syncFunctionHash = null;\n  }\n}\nexport { UboSystem };","map":{"version":3,"names":["UboSystem","constructor","adaptor","_syncFunctionHash","Object","create","_adaptor","_systemCheck","unsafeEvalSupported","Error","ensureUniformGroup","uniformGroup","uniformData","getUniformGroupData","buffer","Buffer","data","Float32Array","layout","size","usage","BufferUsage","UNIFORM","COPY_DST","_signature","_initUniformGroup","uniformGroupSignature","elements","keys","uniformStructures","map","i","createUboElements","syncFunction","_generateUboSync","uboElements","generateUboSync","syncUniformGroup","offset","uniformGroupData","uniforms","updateUniformGroup","isStatic","_dirtyId","synced","update","destroy"],"sources":["/home/ryoitsu/node_modules/pixi.js/src/rendering/renderers/shared/shader/UboSystem.ts"],"sourcesContent":["import { unsafeEvalSupported } from '../../../../utils/browser/unsafeEvalSupported';\nimport { Buffer } from '../buffer/Buffer';\nimport { BufferUsage } from '../buffer/const';\n\nimport type { System } from '../system/System';\nimport type { UboElement, UboLayout, UniformData, UniformsSyncCallback } from './types';\nimport type { UniformGroup } from './UniformGroup';\n\nexport interface UboAdaptor\n{\n    createUboElements: (uniformData: UniformData[]) => UboLayout;\n    generateUboSync: (uboElements: UboElement[]) => UniformsSyncCallback;\n}\n\n/**\n * System plugin to the renderer to manage uniform buffers.\n * @memberof rendering\n */\nexport class UboSystem implements System\n{\n    /** Cache of uniform buffer layouts and sync functions, so we don't have to re-create them */\n    private _syncFunctionHash: Record<string, {\n        layout: UboLayout,\n        syncFunction: (uniforms: Record<string, any>, data: Float32Array, offset: number) => void\n    }> = Object.create(null);\n\n    private readonly _adaptor: UboAdaptor;\n\n    constructor(adaptor: UboAdaptor)\n    {\n        this._adaptor = adaptor;\n\n        // Validation check that this environment support `new Function`\n        this._systemCheck();\n    }\n\n    /**\n     * Overrideable function by `pixi.js/unsafe-eval` to silence\n     * throwing an error if platform doesn't support unsafe-evals.\n     * @private\n     */\n    private _systemCheck(): void\n    {\n        if (!unsafeEvalSupported())\n        {\n            throw new Error('Current environment does not allow unsafe-eval, '\n                 + 'please use pixi.js/unsafe-eval module to enable support.');\n        }\n    }\n\n    public ensureUniformGroup(uniformGroup: UniformGroup): void\n    {\n        const uniformData = this.getUniformGroupData(uniformGroup);\n\n        uniformGroup.buffer ||= new Buffer({\n            data: new Float32Array(uniformData.layout.size / 4),\n            usage: BufferUsage.UNIFORM | BufferUsage.COPY_DST,\n        });\n    }\n\n    public getUniformGroupData(uniformGroup: UniformGroup)\n    {\n        return this._syncFunctionHash[uniformGroup._signature] || this._initUniformGroup(uniformGroup);\n    }\n\n    private _initUniformGroup(uniformGroup: UniformGroup)\n    {\n        const uniformGroupSignature = uniformGroup._signature;\n\n        let uniformData = this._syncFunctionHash[uniformGroupSignature];\n\n        if (!uniformData)\n        {\n            const elements = Object.keys(uniformGroup.uniformStructures).map((i) => uniformGroup.uniformStructures[i]);\n\n            const layout = this._adaptor.createUboElements(elements);\n\n            const syncFunction = this._generateUboSync(layout.uboElements);\n\n            uniformData = this._syncFunctionHash[uniformGroupSignature] = {\n                layout,\n                syncFunction\n            };\n        }\n\n        return this._syncFunctionHash[uniformGroupSignature];\n    }\n\n    private _generateUboSync(\n        uboElements: UboElement[],\n    ): UniformsSyncCallback\n    {\n        return this._adaptor.generateUboSync(uboElements);\n    }\n\n    public syncUniformGroup(uniformGroup: UniformGroup, data?: Float32Array, offset?: number): boolean\n    {\n        const uniformGroupData = this.getUniformGroupData(uniformGroup);\n\n        uniformGroup.buffer ||= new Buffer({\n            data: new Float32Array(uniformGroupData.layout.size / 4),\n            usage: BufferUsage.UNIFORM | BufferUsage.COPY_DST,\n        });\n\n        data ||= (uniformGroup.buffer.data as Float32Array);\n        offset ||= 0;\n\n        uniformGroupData.syncFunction(uniformGroup.uniforms, data, offset);\n\n        return true;\n    }\n\n    public updateUniformGroup(uniformGroup: UniformGroup): boolean\n    {\n        if (uniformGroup.isStatic && !uniformGroup._dirtyId) return false;\n        uniformGroup._dirtyId = 0;\n\n        const synced = this.syncUniformGroup(uniformGroup);\n\n        uniformGroup.buffer.update();\n\n        return synced;\n    }\n\n    public destroy(): void\n    {\n        this._syncFunctionHash = null;\n    }\n}\n"],"mappings":";;;;AAkBO,MAAMA,SACb;EASIC,YAAYC,OACZ;IARA;IAAQ,KAAAC,iBAAA,kBAGIC,MAAA,CAAAC,MAAA,CAAO,IAAI;IAMnB,KAAKC,QAAW,GAAAJ,OAAA;IAGhB,KAAKK,YAAa;EAAA;EACtB;AAAA;AAAA;AAAA;AAAA;EAOQA,YACRA,CAAA;IACQ,KAACC,mBAAA,EACL;MACU,UAAIC,KAAA,CAAM,0GACiD;IAAA;EACrE;EAGGC,mBAAmBC,YAC1B;IACU,MAAAC,WAAA,GAAc,IAAK,CAAAC,mBAAA,CAAoBF,YAAY;IAEzDA,YAAA,CAAaG,MAAb,KAAAH,YAAA,CAAaG,MAAW,OAAIC,MAAO;MAC/BC,IAAA,EAAM,IAAIC,YAAA,CAAaL,WAAY,CAAAM,MAAA,CAAOC,IAAA,GAAO,CAAC;MAClDC,KAAA,EAAOC,WAAY,CAAAC,OAAA,GAAUD,WAAY,CAAAE;IAAA,CAC5C;EAAA;EAGEV,oBAAoBF,YAC3B;IACI,OAAO,KAAKR,iBAAkB,CAAAQ,YAAA,CAAaa,UAAU,CAAK,SAAKC,iBAAA,CAAkBd,YAAY;EAAA;EAGzFc,kBAAkBd,YAC1B;IACI,MAAMe,qBAAA,GAAwBf,YAAa,CAAAa,UAAA;IAEvC,IAAAZ,WAAA,GAAc,IAAK,CAAAT,iBAAA,CAAkBuB,qBAAqB;IAE9D,IAAI,CAACd,WACL;MACI,MAAMe,QAAW,GAAAvB,MAAA,CAAOwB,IAAK,CAAAjB,YAAA,CAAakB,iBAAiB,EAAEC,GAAI,CAACC,CAAM,IAAApB,YAAA,CAAakB,iBAAkB,CAAAE,CAAC,CAAC;MAEzG,MAAMb,MAAS,QAAKZ,QAAS,CAAA0B,iBAAA,CAAkBL,QAAQ;MAEvD,MAAMM,YAAe,QAAKC,gBAAiB,CAAAhB,MAAA,CAAOiB,WAAW;MAE/CvB,WAAA,QAAKT,iBAAkB,CAAAuB,qBAAqB,CAAI;QAC1DR,MAAA;QACAe;MAAA,CACJ;IAAA;IAGG,YAAK9B,iBAAA,CAAkBuB,qBAAqB;EAAA;EAG/CQ,iBACJC,WAEJ;IACW,YAAK7B,QAAS,CAAA8B,eAAA,CAAgBD,WAAW;EAAA;EAG7CE,iBAAiB1B,YAA4B,EAAAK,IAAA,EAAqBsB,MACzE;IACU,MAAAC,gBAAA,GAAmB,IAAK,CAAA1B,mBAAA,CAAoBF,YAAY;IAE9DA,YAAA,CAAaG,MAAb,KAAAH,YAAA,CAAaG,MAAW,OAAIC,MAAO;MAC/BC,IAAA,EAAM,IAAIC,YAAA,CAAasB,gBAAiB,CAAArB,MAAA,CAAOC,IAAA,GAAO,CAAC;MACvDC,KAAA,EAAOC,WAAY,CAAAC,OAAA,GAAUD,WAAY,CAAAE;IAAA,CAC5C;IAEDP,IAAA,KAAAA,IAAA,GAAUL,YAAA,CAAaG,MAAO,CAAAE,IAAA;IACnBsB,MAAA,KAAAA,MAAA;IAEXC,gBAAA,CAAiBN,YAAa,CAAAtB,YAAA,CAAa6B,QAAU,EAAAxB,IAAA,EAAMsB,MAAM;IAE1D;EAAA;EAGJG,mBAAmB9B,YAC1B;IACQ,IAAAA,YAAA,CAAa+B,QAAY,KAAC/B,YAAa,CAAAgC,QAAA,EAAiB;IAC5DhC,YAAA,CAAagC,QAAW;IAElB,MAAAC,MAAA,GAAS,IAAK,CAAAP,gBAAA,CAAiB1B,YAAY;IAEjDA,YAAA,CAAaG,MAAA,CAAO+B,MAAO;IAEpB,OAAAD,MAAA;EAAA;EAGJE,OACPA,CAAA;IACI,KAAK3C,iBAAoB;EAAA;AAEjC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}