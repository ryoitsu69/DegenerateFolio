{"ast":null,"code":"import { catchError, combineLatest, map, of, switchMap } from 'rxjs';\nimport { isNumber, isUndefined } from '@polkadot/util';\nimport { unwrapBlockNumber } from '../util/index.js';\nimport { FALLBACK_MAX_HASH_COUNT, FALLBACK_PERIOD, MAX_FINALITY_LAG, MORTAL_PERIOD } from './constants.js';\nfunction latestNonce(api, address) {\n  return api.derive.balances.account(address).pipe(map(({\n    accountNonce\n  }) => accountNonce));\n}\nfunction nextNonce(api, address) {\n  return api.rpc.system?.accountNextIndex ? api.rpc.system.accountNextIndex(address) : latestNonce(api, address);\n}\nfunction signingHeader(api) {\n  return combineLatest([api.rpc.chain.getHeader().pipe(switchMap(header =>\n  // check for chains at genesis (until block 1 is produced, e.g. 6s), since\n  // we do need to allow transactions at chain start (also dev/seal chains)\n  header.parentHash.isEmpty ? of(header)\n  // in the case of the current block, we use the parent to minimize the\n  // impact of forks on the system, but not completely remove it\n  : api.rpc.chain.getHeader(header.parentHash).pipe(catchError(() => of(header))))), api.rpc.chain.getFinalizedHead().pipe(switchMap(hash => api.rpc.chain.getHeader(hash).pipe(catchError(() => of(null)))))]).pipe(map(([current, finalized]) =>\n  // determine the hash to use, current when lag > max, else finalized\n  !finalized || unwrapBlockNumber(current).sub(unwrapBlockNumber(finalized)).gt(MAX_FINALITY_LAG) ? current : finalized));\n}\nfunction babeOrAuraPeriod(api) {\n  const period = api.consts.babe?.expectedBlockTime ||\n  // this will be present ones https://github.com/paritytech/polkadot-sdk/pull/3732 is merged\n  api.consts['aura']?.slotDuration || api.consts.timestamp?.minimumPeriod.muln(2);\n  return !period.isZero() ? period : undefined;\n}\nexport function signingInfo(_instanceId, api) {\n  // no memo, we want to do this fresh on each run\n  return (address, nonce, era) => combineLatest([\n  // retrieve nonce if none was specified\n  isUndefined(nonce) ? latestNonce(api, address) : nonce === -1 ? nextNonce(api, address) : of(api.registry.createType('Index', nonce)),\n  // if no era (create) or era > 0 (mortal), do block retrieval\n  isUndefined(era) || isNumber(era) && era > 0 ? signingHeader(api) : of(null)]).pipe(map(([nonce, header]) => ({\n    header,\n    mortalLength: Math.min(api.consts.system?.blockHashCount?.toNumber() || FALLBACK_MAX_HASH_COUNT, MORTAL_PERIOD.div(babeOrAuraPeriod(api) || FALLBACK_PERIOD).iadd(MAX_FINALITY_LAG).toNumber()),\n    nonce\n  })));\n}","map":{"version":3,"names":["catchError","combineLatest","map","of","switchMap","isNumber","isUndefined","unwrapBlockNumber","FALLBACK_MAX_HASH_COUNT","FALLBACK_PERIOD","MAX_FINALITY_LAG","MORTAL_PERIOD","latestNonce","api","address","derive","balances","account","pipe","accountNonce","nextNonce","rpc","system","accountNextIndex","signingHeader","chain","getHeader","header","parentHash","isEmpty","getFinalizedHead","hash","current","finalized","sub","gt","babeOrAuraPeriod","period","consts","babe","expectedBlockTime","slotDuration","timestamp","minimumPeriod","muln","isZero","undefined","signingInfo","_instanceId","nonce","era","registry","createType","mortalLength","Math","min","blockHashCount","toNumber","div","iadd"],"sources":["/home/ryoitsu/Documents/test/react-todo-app/node_modules/@polkadot/api-derive/tx/signingInfo.js"],"sourcesContent":["import { catchError, combineLatest, map, of, switchMap } from 'rxjs';\nimport { isNumber, isUndefined } from '@polkadot/util';\nimport { unwrapBlockNumber } from '../util/index.js';\nimport { FALLBACK_MAX_HASH_COUNT, FALLBACK_PERIOD, MAX_FINALITY_LAG, MORTAL_PERIOD } from './constants.js';\nfunction latestNonce(api, address) {\n    return api.derive.balances.account(address).pipe(map(({ accountNonce }) => accountNonce));\n}\nfunction nextNonce(api, address) {\n    return api.rpc.system?.accountNextIndex\n        ? api.rpc.system.accountNextIndex(address)\n        : latestNonce(api, address);\n}\nfunction signingHeader(api) {\n    return combineLatest([\n        api.rpc.chain.getHeader().pipe(switchMap((header) => \n        // check for chains at genesis (until block 1 is produced, e.g. 6s), since\n        // we do need to allow transactions at chain start (also dev/seal chains)\n        header.parentHash.isEmpty\n            ? of(header)\n            // in the case of the current block, we use the parent to minimize the\n            // impact of forks on the system, but not completely remove it\n            : api.rpc.chain.getHeader(header.parentHash).pipe(catchError(() => of(header))))),\n        api.rpc.chain.getFinalizedHead().pipe(switchMap((hash) => api.rpc.chain.getHeader(hash).pipe(catchError(() => of(null)))))\n    ]).pipe(map(([current, finalized]) => \n    // determine the hash to use, current when lag > max, else finalized\n    !finalized || unwrapBlockNumber(current).sub(unwrapBlockNumber(finalized)).gt(MAX_FINALITY_LAG)\n        ? current\n        : finalized));\n}\nfunction babeOrAuraPeriod(api) {\n    const period = api.consts.babe?.expectedBlockTime ||\n        // this will be present ones https://github.com/paritytech/polkadot-sdk/pull/3732 is merged\n        api.consts['aura']?.slotDuration ||\n        api.consts.timestamp?.minimumPeriod.muln(2);\n    return !period.isZero() ? period : undefined;\n}\nexport function signingInfo(_instanceId, api) {\n    // no memo, we want to do this fresh on each run\n    return (address, nonce, era) => combineLatest([\n        // retrieve nonce if none was specified\n        isUndefined(nonce)\n            ? latestNonce(api, address)\n            : nonce === -1\n                ? nextNonce(api, address)\n                : of(api.registry.createType('Index', nonce)),\n        // if no era (create) or era > 0 (mortal), do block retrieval\n        (isUndefined(era) || (isNumber(era) && era > 0))\n            ? signingHeader(api)\n            : of(null)\n    ]).pipe(map(([nonce, header]) => ({\n        header,\n        mortalLength: Math.min(api.consts.system?.blockHashCount?.toNumber() || FALLBACK_MAX_HASH_COUNT, MORTAL_PERIOD\n            .div(babeOrAuraPeriod(api) || FALLBACK_PERIOD)\n            .iadd(MAX_FINALITY_LAG)\n            .toNumber()),\n        nonce\n    })));\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}