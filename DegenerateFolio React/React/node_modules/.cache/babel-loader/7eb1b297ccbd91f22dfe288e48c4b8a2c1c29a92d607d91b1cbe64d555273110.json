{"ast":null,"code":"import Nacl from \"tweetnacl\";\nimport { Result } from \"../../helpers/result.js\";\nimport { debug } from \"../../helpers/debug.js\";\nimport { TRANS_BY_HASH, TRANS_BY_VERSION } from \"../../helpers/const.js\";\nconst {\n  sign\n} = Nacl;\nexport const TransactionApi = {\n  lastTransaction: null,\n  async getTransactions() {\n    let query = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n      limit: 25,\n      start: 0\n    };\n    return await this._exec(\"/transactions\", query);\n  },\n  async getTransaction(hash) {\n    let by = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : TRANS_BY_HASH;\n    return await this._exec(\"/transactions/\".concat(by, \"/\").concat(hash));\n  },\n  async getTransactionByHash(hash) {\n    return await this.getTransaction(hash, TRANS_BY_HASH);\n  },\n  async getTransactionByVersion(version) {\n    return await this.getTransaction(version, TRANS_BY_VERSION);\n  },\n  async buildTransaction(senderAddress, payload) {\n    let exp = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 600;\n    let account,\n      address = this._0x(senderAddress);\n    account = await this._exec(\"/accounts/\".concat(address));\n    if (!account.ok) {\n      return account;\n    }\n    return new Result(true, \"OK\", {\n      \"sender\": address,\n      \"sequence_number\": \"\" + account.payload.sequence_number,\n      \"max_gas_amount\": \"\" + this.gas.max_gas_amount,\n      \"gas_unit_price\": \"\" + this.gas.gas_unit_price,\n      \"gas_currency_code\": \"\" + this.gas.gas_currency_code,\n      \"expiration_timestamp_secs\": (Math.floor(Date.now() / 1000) + exp).toString(),\n      // Unix timestamp, in seconds + 10 minutes ???\n      \"payload\": payload\n    });\n  },\n  async createSigningMessage(txnRequest) {\n    return await this._exec(\"/transactions/encode_submission\", null, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify(txnRequest)\n    });\n  },\n  async signTransaction(signer) {\n    let trx = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    const signedMessage = await this.createSigningMessage(trx);\n    if (!signedMessage.ok) {\n      return new Result(false, signedMessage.message, signedMessage);\n    }\n    const toSign = Buffer.from(signedMessage.payload.substring(2), \"hex\");\n    const signature = sign(toSign, signer.signingKey.secretKey);\n    const signatureHex = Buffer.from(signature).toString(\"hex\").slice(0, 128);\n    trx[\"signature\"] = {\n      \"type\": \"ed25519_signature\",\n      \"public_key\": \"\".concat(this._0x(signer.pubKey())),\n      \"signature\": \"\".concat(this._0x(signatureHex))\n    };\n    return new Result(true, \"OK\", trx);\n  },\n  async submitTransactionData(data) {\n    return await this._exec(\"/transactions\", null, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify(data)\n    });\n  },\n  async simulateTransaction(data) {\n    return await this._exec(\"/transactions/simulate\", null, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify(data)\n    });\n  },\n  async submitTransaction(account, payload) {\n    const transaction = await this.buildTransaction(account.address(), payload);\n    if (!transaction.ok) return new Result(false, transaction.message, transaction);\n    const signedTransaction = await this.signTransaction(account, transaction.payload);\n    if (!signedTransaction.ok) return new Result(false, signedTransaction.message, signedTransaction);\n    const result = await this.submitTransactionData(signedTransaction.payload);\n    if (!result.ok) {\n      return new Result(false, \"Error submitting transaction data\", result.error);\n    }\n    try {\n      await this.waitForTransaction(result.payload.hash);\n      this.lastTransaction = (await this.getTransaction(result.payload.hash)).payload;\n      return new Result(true, \"ok\", this.lastTransaction);\n    } catch (e) {\n      return new Result(false, e.message, e.stack);\n    }\n  },\n  async transactionPending(hash) {\n    const response = await this.getTransaction(hash);\n    if (!response.ok && response.error.code === 404) {\n      return true;\n    }\n    return response.payload.type === \"pending_transaction\";\n  },\n  async waitForTransaction(hash) {\n    let count = 0;\n    while (await this.transactionPending(hash)) {\n      await this.sleep(1000);\n      count += 1;\n      if (count >= 10) {\n        throw new Error(\"Waiting for transaction \".concat(hash, \" timed out!\"));\n      }\n    }\n  },\n  getLastTransaction() {\n    return this.lastTransaction;\n  },\n  lastTransactionStatus() {\n    const {\n      type,\n      version,\n      timestamp,\n      hash,\n      success,\n      gas_used,\n      max_gas_amount,\n      gas_unit_price,\n      sequence_number,\n      vm_status\n    } = this.lastTransaction;\n    return {\n      type,\n      hash,\n      version,\n      success,\n      vm_status,\n      timestamp,\n      sequence_number,\n      gas: {\n        gas_used,\n        max_gas_amount,\n        gas_unit_price\n      }\n    };\n  }\n};","map":{"version":3,"names":["Nacl","Result","debug","TRANS_BY_HASH","TRANS_BY_VERSION","sign","TransactionApi","lastTransaction","getTransactions","query","arguments","length","undefined","limit","start","_exec","getTransaction","hash","by","concat","getTransactionByHash","getTransactionByVersion","version","buildTransaction","senderAddress","payload","exp","account","address","_0x","ok","sequence_number","gas","max_gas_amount","gas_unit_price","gas_currency_code","Math","floor","Date","now","toString","createSigningMessage","txnRequest","method","headers","body","JSON","stringify","signTransaction","signer","trx","signedMessage","message","toSign","Buffer","from","substring","signature","signingKey","secretKey","signatureHex","slice","pubKey","submitTransactionData","data","simulateTransaction","submitTransaction","transaction","signedTransaction","result","error","waitForTransaction","e","stack","transactionPending","response","code","type","count","sleep","Error","getLastTransaction","lastTransactionStatus","timestamp","success","gas_used","vm_status"],"sources":["/home/ryoitsu/Documents/test/react-todo-app/node_modules/aptos-api-master/src/api/ext/transactions.js"],"sourcesContent":["import Nacl from \"tweetnacl\"\nimport {Result} from \"../../helpers/result.js\";\nimport {debug} from \"../../helpers/debug.js\";\nimport {TRANS_BY_HASH, TRANS_BY_VERSION} from \"../../helpers/const.js\";\n\nconst {sign} = Nacl\n\nexport const TransactionApi = {\n    lastTransaction: null,\n\n    async getTransactions(query = {limit: 25, start: 0}){\n        return await this._exec(`/transactions`, query)\n    },\n\n    async getTransaction(hash, by = TRANS_BY_HASH){\n        return await this._exec(`/transactions/${by}/${hash}`)\n    },\n\n    async getTransactionByHash(hash){\n        return await this.getTransaction(hash, TRANS_BY_HASH)\n    },\n\n    async getTransactionByVersion(version){\n        return await this.getTransaction(version, TRANS_BY_VERSION)\n    },\n\n    async buildTransaction(senderAddress, payload, exp = 600){\n        let account, address = this._0x(senderAddress)\n\n        account = await this._exec(`/accounts/${address}`)\n\n        if (!account.ok) {\n            return account\n        }\n\n        return new Result(true, \"OK\", {\n            \"sender\": address,\n            \"sequence_number\": \"\"+account.payload.sequence_number,\n            \"max_gas_amount\": \"\"+this.gas.max_gas_amount,\n            \"gas_unit_price\": \"\"+this.gas.gas_unit_price,\n            \"gas_currency_code\": \"\"+this.gas.gas_currency_code,\n            \"expiration_timestamp_secs\": (Math.floor(Date.now() / 1000) + exp).toString(), // Unix timestamp, in seconds + 10 minutes ???\n            \"payload\": payload,\n        })\n    },\n\n    async createSigningMessage(txnRequest){\n        return await this._exec(`/transactions/encode_submission`, null, {\n            method: \"POST\",\n            headers: {\"Content-Type\": \"application/json\"},\n            body: JSON.stringify(txnRequest)\n        })\n    },\n\n    async signTransaction(signer, trx = {}){\n        const signedMessage = await this.createSigningMessage(trx)\n\n        if (!signedMessage.ok) {\n            return new Result(false, signedMessage.message, signedMessage)\n        }\n\n        const toSign = Buffer.from(signedMessage.payload.substring(2), \"hex\")\n        const signature = sign(toSign, signer.signingKey.secretKey)\n        const signatureHex = Buffer.from(signature).toString(\"hex\").slice(0, 128)\n\n        trx[\"signature\"] = {\n            \"type\": \"ed25519_signature\",\n            \"public_key\": `${this._0x(signer.pubKey())}`,\n            \"signature\": `${this._0x(signatureHex)}`,\n        }\n\n        return new Result(true, \"OK\", trx)\n    },\n\n    async submitTransactionData(data){\n        return await this._exec(`/transactions`, null, {\n            method: \"POST\",\n            headers: {\"Content-Type\": \"application/json\"},\n            body: JSON.stringify(data)\n        })\n    },\n\n    async simulateTransaction(data){\n        return await this._exec(`/transactions/simulate`, null, {\n            method: \"POST\",\n            headers: {\"Content-Type\": \"application/json\"},\n            body: JSON.stringify(data)\n        })\n    },\n\n    async submitTransaction(account, payload){\n        const transaction = await this.buildTransaction(account.address(), payload)\n        if (!transaction.ok) return new Result(false, transaction.message, transaction)\n\n        const signedTransaction = await this.signTransaction(account, transaction.payload)\n        if (!signedTransaction.ok) return new Result(false, signedTransaction.message, signedTransaction)\n\n        const result = await this.submitTransactionData(signedTransaction.payload)\n\n        if (!result.ok) {\n            return new Result(false, \"Error submitting transaction data\", result.error)\n        }\n\n        try {\n            await this.waitForTransaction(result.payload.hash)\n            this.lastTransaction = (await this.getTransaction(result.payload.hash)).payload\n            return new Result(true, \"ok\", this.lastTransaction)\n        } catch (e) {\n            return new Result(false, e.message, e.stack)\n        }\n    },\n\n    async transactionPending(hash){\n        const response = await this.getTransaction(hash)\n        if (!response.ok && response.error.code === 404) {\n            return true\n        }\n        return response.payload.type === \"pending_transaction\"\n    },\n\n    async waitForTransaction(hash) {\n        let count = 0\n        while (await this.transactionPending(hash)) {\n            await this.sleep(1000)\n            count += 1\n            if (count >= 10) {\n                throw new Error(`Waiting for transaction ${hash} timed out!`)\n            }\n        }\n    },\n\n    getLastTransaction(){\n        return this.lastTransaction\n    },\n\n    lastTransactionStatus(){\n        const {type, version, timestamp, hash, success, gas_used, max_gas_amount, gas_unit_price, sequence_number, vm_status} = this.lastTransaction\n        return {\n            type,\n            hash,\n            version,\n            success,\n            vm_status,\n            timestamp,\n            sequence_number,\n            gas: {\n                gas_used,\n                max_gas_amount,\n                gas_unit_price\n            }\n        }\n    }\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}