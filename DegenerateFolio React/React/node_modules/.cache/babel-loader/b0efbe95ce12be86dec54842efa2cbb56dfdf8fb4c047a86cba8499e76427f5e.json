{"ast":null,"code":"import { ExtensionType, extensions } from \"@pixi/extensions\";\nclass TransformFeedbackSystem {\n  /**\n   * @param renderer - The renderer this System works for.\n   */\n  constructor(renderer) {\n    this.renderer = renderer;\n  }\n  /** Sets up the renderer context and necessary buffers. */\n  contextChange() {\n    this.gl = this.renderer.gl, this.CONTEXT_UID = this.renderer.CONTEXT_UID;\n  }\n  /**\n   * Bind TransformFeedback and buffers\n   * @param transformFeedback - TransformFeedback to bind\n   */\n  bind(transformFeedback) {\n    const {\n        gl,\n        CONTEXT_UID\n      } = this,\n      glTransformFeedback = transformFeedback._glTransformFeedbacks[CONTEXT_UID] || this.createGLTransformFeedback(transformFeedback);\n    gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, glTransformFeedback);\n  }\n  /** Unbind TransformFeedback */\n  unbind() {\n    const {\n      gl\n    } = this;\n    gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);\n  }\n  /**\n   * Begin TransformFeedback\n   * @param drawMode - DrawMode for TransformFeedback\n   * @param shader - A Shader used by TransformFeedback. Current bound shader will be used if not provided.\n   */\n  beginTransformFeedback(drawMode, shader) {\n    const {\n      gl,\n      renderer\n    } = this;\n    shader && renderer.shader.bind(shader), gl.beginTransformFeedback(drawMode);\n  }\n  /** End TransformFeedback */\n  endTransformFeedback() {\n    const {\n      gl\n    } = this;\n    gl.endTransformFeedback();\n  }\n  /**\n   * Create TransformFeedback and bind buffers\n   * @param tf - TransformFeedback\n   * @returns WebGLTransformFeedback\n   */\n  createGLTransformFeedback(tf) {\n    const {\n        gl,\n        renderer,\n        CONTEXT_UID\n      } = this,\n      glTransformFeedback = gl.createTransformFeedback();\n    tf._glTransformFeedbacks[CONTEXT_UID] = glTransformFeedback, gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, glTransformFeedback);\n    for (let i = 0; i < tf.buffers.length; i++) {\n      const buffer = tf.buffers[i];\n      buffer && (renderer.buffer.update(buffer), buffer._glBuffers[CONTEXT_UID].refCount++, gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, i, buffer._glBuffers[CONTEXT_UID].buffer || null));\n    }\n    return gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null), tf.disposeRunner.add(this), glTransformFeedback;\n  }\n  /**\n   * Disposes TransfromFeedback\n   * @param {PIXI.TransformFeedback} tf - TransformFeedback\n   * @param {boolean} [contextLost=false] - If context was lost, we suppress delete TransformFeedback\n   */\n  disposeTransformFeedback(tf, contextLost) {\n    const glTF = tf._glTransformFeedbacks[this.CONTEXT_UID],\n      gl = this.gl;\n    tf.disposeRunner.remove(this);\n    const bufferSystem = this.renderer.buffer;\n    if (bufferSystem) for (let i = 0; i < tf.buffers.length; i++) {\n      const buffer = tf.buffers[i];\n      if (!buffer) continue;\n      const buf = buffer._glBuffers[this.CONTEXT_UID];\n      buf && (buf.refCount--, buf.refCount === 0 && !contextLost && bufferSystem.dispose(buffer, contextLost));\n    }\n    glTF && (contextLost || gl.deleteTransformFeedback(glTF), delete tf._glTransformFeedbacks[this.CONTEXT_UID]);\n  }\n  destroy() {\n    this.renderer = null;\n  }\n}\nTransformFeedbackSystem.extension = {\n  type: ExtensionType.RendererSystem,\n  name: \"transformFeedback\"\n};\nextensions.add(TransformFeedbackSystem);\nexport { TransformFeedbackSystem };","map":{"version":3,"names":["TransformFeedbackSystem","constructor","renderer","contextChange","gl","CONTEXT_UID","bind","transformFeedback","glTransformFeedback","_glTransformFeedbacks","createGLTransformFeedback","bindTransformFeedback","TRANSFORM_FEEDBACK","unbind","beginTransformFeedback","drawMode","shader","endTransformFeedback","tf","createTransformFeedback","i","buffers","length","buffer","update","_glBuffers","refCount","bindBufferBase","TRANSFORM_FEEDBACK_BUFFER","disposeRunner","add","disposeTransformFeedback","contextLost","glTF","remove","bufferSystem","buf","dispose","deleteTransformFeedback","destroy","extension","type","ExtensionType","RendererSystem","name","extensions"],"sources":["/home/ryoitsu/node_modules/@pixi/core/src/transformFeedback/TransformFeedbackSystem.ts"],"sourcesContent":["import { extensions, ExtensionType } from '@pixi/extensions';\n\nimport type { DRAW_MODES } from '@pixi/constants';\nimport type { ExtensionMetadata } from '@pixi/extensions';\nimport type { IRenderingContext } from '../IRenderer';\nimport type { Renderer } from '../Renderer';\nimport type { Shader } from '../shader/Shader';\nimport type { ISystem } from '../system/ISystem';\nimport type { TransformFeedback } from './TransformFeedback';\n\n/**\n * TransformFeedbackSystem provides TransformFeedback of WebGL2\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLTransformFeedback\n *\n * For example, you can use TransformFeedbackSystem to implement GPU Particle or\n * general purpose computing on GPU (aka GPGPU).\n *\n * It also manages a lifetime of GLTransformFeedback object\n * @memberof PIXI\n */\nexport class TransformFeedbackSystem implements ISystem\n{\n    /** @ignore */\n    static extension: ExtensionMetadata = {\n        type:  ExtensionType.RendererSystem,\n        name: 'transformFeedback',\n    };\n\n    CONTEXT_UID: number;\n    gl: IRenderingContext;\n\n    private renderer: Renderer;\n\n    /**\n     * @param renderer - The renderer this System works for.\n     */\n    constructor(renderer: Renderer)\n    {\n        this.renderer = renderer;\n    }\n\n    /** Sets up the renderer context and necessary buffers. */\n    protected contextChange(): void\n    {\n        this.gl = this.renderer.gl;\n\n        // TODO fill out...\n        this.CONTEXT_UID = this.renderer.CONTEXT_UID;\n    }\n\n    /**\n     * Bind TransformFeedback and buffers\n     * @param transformFeedback - TransformFeedback to bind\n     */\n    bind(transformFeedback: TransformFeedback)\n    {\n        const { gl, CONTEXT_UID } = this;\n\n        const glTransformFeedback = transformFeedback._glTransformFeedbacks[CONTEXT_UID]\n          || this.createGLTransformFeedback(transformFeedback);\n\n        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, glTransformFeedback);\n    }\n\n    /** Unbind TransformFeedback */\n    unbind()\n    {\n        const { gl } = this;\n\n        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);\n    }\n\n    /**\n     * Begin TransformFeedback\n     * @param drawMode - DrawMode for TransformFeedback\n     * @param shader - A Shader used by TransformFeedback. Current bound shader will be used if not provided.\n     */\n    beginTransformFeedback(drawMode: DRAW_MODES, shader?: Shader)\n    {\n        const { gl, renderer } = this;\n\n        if (shader)\n        {\n            renderer.shader.bind(shader);\n        }\n\n        gl.beginTransformFeedback(drawMode);\n    }\n\n    /** End TransformFeedback */\n    endTransformFeedback()\n    {\n        const { gl } = this;\n\n        gl.endTransformFeedback();\n    }\n\n    /**\n     * Create TransformFeedback and bind buffers\n     * @param tf - TransformFeedback\n     * @returns WebGLTransformFeedback\n     */\n    protected createGLTransformFeedback(tf: TransformFeedback)\n    {\n        const { gl, renderer, CONTEXT_UID } = this;\n\n        const glTransformFeedback = gl.createTransformFeedback();\n\n        tf._glTransformFeedbacks[CONTEXT_UID] = glTransformFeedback;\n        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, glTransformFeedback);\n        for (let i = 0; i < tf.buffers.length; i++)\n        {\n            const buffer = tf.buffers[i];\n\n            if (!buffer) continue;\n\n            renderer.buffer.update(buffer);\n            buffer._glBuffers[CONTEXT_UID].refCount++;\n\n            gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, i, buffer._glBuffers[CONTEXT_UID].buffer || null);\n        }\n        gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);\n\n        tf.disposeRunner.add(this);\n\n        return glTransformFeedback;\n    }\n\n    /**\n     * Disposes TransfromFeedback\n     * @param {PIXI.TransformFeedback} tf - TransformFeedback\n     * @param {boolean} [contextLost=false] - If context was lost, we suppress delete TransformFeedback\n     */\n    disposeTransformFeedback(tf: TransformFeedback, contextLost?: boolean): void\n    {\n        const glTF = tf._glTransformFeedbacks[this.CONTEXT_UID];\n        const gl = this.gl;\n\n        tf.disposeRunner.remove(this);\n\n        const bufferSystem = this.renderer.buffer;\n\n        // bufferSystem may have already been destroyed..\n        // if this is the case, there is no need to destroy the geometry buffers...\n        // they already have been!\n        if (bufferSystem)\n        {\n            for (let i = 0; i < tf.buffers.length; i++)\n            {\n                const buffer = tf.buffers[i];\n\n                if (!buffer) continue;\n\n                const buf = buffer._glBuffers[this.CONTEXT_UID];\n\n                // my be null as context may have changed right before the dispose is called\n                if (buf)\n                {\n                    buf.refCount--;\n                    if (buf.refCount === 0 && !contextLost)\n                    {\n                        bufferSystem.dispose(buffer, contextLost);\n                    }\n                }\n            }\n        }\n\n        if (!glTF)\n        {\n            return;\n        }\n\n        if (!contextLost)\n        {\n            gl.deleteTransformFeedback(glTF);\n        }\n\n        delete tf._glTransformFeedbacks[this.CONTEXT_UID];\n    }\n\n    destroy(): void\n    {\n        // @TODO: Destroy managed TransformFeedbacks\n        this.renderer = null;\n    }\n}\n\nextensions.add(TransformFeedbackSystem);\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}