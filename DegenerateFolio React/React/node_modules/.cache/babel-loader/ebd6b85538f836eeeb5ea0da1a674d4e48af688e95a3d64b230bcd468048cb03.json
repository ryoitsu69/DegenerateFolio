{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ReconnectingSocket = void 0;\nconst xstream_1 = require(\"xstream\");\nconst queueingstreamingsocket_1 = require(\"./queueingstreamingsocket\");\n/**\n * A wrapper around QueueingStreamingSocket that reconnects automatically.\n */\nclass ReconnectingSocket {\n  /** Starts with a 0.1 second timeout, then doubles every attempt with a maximum timeout of 5 seconds. */\n  static calculateTimeout(index) {\n    return Math.min(2 ** index * 100, 5000);\n  }\n  constructor(url, timeout = 10000, reconnectedHandler) {\n    this.unconnected = true;\n    this.disconnected = false;\n    this.timeoutIndex = 0;\n    this.reconnectTimeout = null;\n    const eventProducer = {\n      start: listener => this.eventProducerListener = listener,\n      stop: () => this.eventProducerListener = undefined\n    };\n    this.events = xstream_1.Stream.create(eventProducer);\n    this.socket = new queueingstreamingsocket_1.QueueingStreamingSocket(url, timeout, reconnectedHandler);\n    this.socket.events.subscribe({\n      next: event => {\n        if (this.eventProducerListener) {\n          this.eventProducerListener.next(event);\n        }\n      },\n      error: error => {\n        if (this.eventProducerListener) {\n          this.eventProducerListener.error(error);\n        }\n      }\n    });\n    this.connectionStatus = this.socket.connectionStatus;\n    this.connectionStatus.updates.subscribe({\n      next: status => {\n        if (status === queueingstreamingsocket_1.ConnectionStatus.Connected) {\n          this.timeoutIndex = 0;\n        }\n        if (status === queueingstreamingsocket_1.ConnectionStatus.Disconnected) {\n          if (this.reconnectTimeout) {\n            clearTimeout(this.reconnectTimeout);\n            this.reconnectTimeout = null;\n          }\n          this.reconnectTimeout = setTimeout(() => this.socket.reconnect(), ReconnectingSocket.calculateTimeout(this.timeoutIndex++));\n        }\n      }\n    });\n  }\n  connect() {\n    if (!this.unconnected) {\n      throw new Error(\"Cannot connect: socket has already connected\");\n    }\n    this.socket.connect();\n    this.unconnected = false;\n  }\n  disconnect() {\n    if (this.unconnected) {\n      throw new Error(\"Cannot disconnect: socket has not yet connected\");\n    }\n    this.socket.disconnect();\n    if (this.eventProducerListener) {\n      this.eventProducerListener.complete();\n    }\n    this.disconnected = true;\n  }\n  queueRequest(request) {\n    if (this.disconnected) {\n      throw new Error(\"Cannot queue request: socket has disconnected\");\n    }\n    this.socket.queueRequest(request);\n  }\n}\nexports.ReconnectingSocket = ReconnectingSocket;","map":{"version":3,"names":["xstream_1","require","queueingstreamingsocket_1","ReconnectingSocket","calculateTimeout","index","Math","min","constructor","url","timeout","reconnectedHandler","unconnected","disconnected","timeoutIndex","reconnectTimeout","eventProducer","start","listener","eventProducerListener","stop","undefined","events","Stream","create","socket","QueueingStreamingSocket","subscribe","next","event","error","connectionStatus","updates","status","ConnectionStatus","Connected","Disconnected","clearTimeout","setTimeout","reconnect","connect","Error","disconnect","complete","queueRequest","request","exports"],"sources":["../src/reconnectingsocket.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}